<!DOCTYPE html>
<html>
<head>
  <title>RunDown - Preferences</title>
  <link rel="icon" type="image/png" href="/static/icon/icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/static/css/styles.css">
  <link rel="stylesheet" href="/static/css/preferences.css">
</head>
<body>
  <!-- Top Navigation Bar -->
  <div class="top-nav">
    <div class="logo">RunDown</div>
    <nav class="nav-links">
      
      <a href="https://outlook.live.com/mail" target="_blank">Emails</a>
      <a href="https://outlook.live.com/calendar" target="_blank">Calendar</a>
      <a href="/">Dashboard</a>
      <a href="/logout">Logout</a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="preferences-container">
      <h1 class="preferences-title">Your Preferences</h1>
      
      <div class="preferences-section">
        <h2>Interest Categories</h2>
        <p>Select the categories you're interested in. We'll use these to filter email suggestions and make your experience more relevant.</p>
        
        <div class="checkboxes" id="interests-container">
          {% for category in categories %}
          <div class="checkbox-item">
            <input type="checkbox" id="category-{{ loop.index }}" name="interests" value="{{ category }}" 
                  {% if category in user_preferences.interests %}checked{% endif %}>
            <label for="category-{{ loop.index }}">{{ category }}</label>
          </div>
          {% endfor %}
        </div>
        
        <div class="custom-interests">
          <h3>Custom Interests</h3>
          <p>Add your own custom interest categories that aren't listed above.</p>
          
          <div class="custom-interests-list" id="custom-interests-list">
            {% if user_preferences.custom_interests %}
              {% for custom_interest in user_preferences.custom_interests %}
                <div class="custom-interest-tag">
                  {{ custom_interest }}
                  <button type="button" class="remove-custom" data-interest="{{ custom_interest }}">×</button>
                </div>
              {% endfor %}
            {% endif %}
          </div>
          
          <div class="custom-interest-input">
            <input type="text" id="custom-interest-input" placeholder="Enter a custom interest...">
            <button type="button" id="add-custom-btn" class="add-custom-btn">Add</button>
          </div>
        </div>
      </div>
      
      <div class="preferences-section">
        <h2>Email Filtering</h2>
        <div class="checkbox-item">
          <input type="checkbox" id="enable-filtering" name="enable-filtering" 
                {% if user_preferences.enabled %}checked{% endif %}>
          <label for="enable-filtering">Enable smart email filtering</label>
        </div>
        <p class="hint">When enabled, we'll only suggest tasks from emails that match your interests.</p>
      </div>
      
      <button id="save-preferences" class="btn-save">Save Preferences</button>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const saveButton = document.getElementById('save-preferences');
      const successMessage = document.getElementById('success-message');
      const customInput = document.getElementById('custom-interest-input');
      const addCustomBtn = document.getElementById('add-custom-btn');
      const customList = document.getElementById('custom-interests-list');
      
      // Initial set of custom interests (from server)
      let customInterests = [];
      {% if user_preferences.custom_interests %}
        customInterests = {{ user_preferences.custom_interests|tojson }};
      {% endif %}
      
      // Add a custom interest
      function addCustomInterest(interest) {
        if (!interest || customInterests.includes(interest)) return;
        
        customInterests.push(interest);
        
        const tag = document.createElement('div');
        tag.className = 'custom-interest-tag';
        tag.innerHTML = `
          ${interest}
          <button type="button" class="remove-custom" data-interest="${interest}">×</button>
        `;
        customList.appendChild(tag);
        
        // Clear input
        customInput.value = '';
      }
      
      // Handle add button click
      addCustomBtn.addEventListener('click', () => {
        const interest = customInput.value.trim();
        addCustomInterest(interest);
      });
      
      // Handle Enter key in input
      customInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const interest = customInput.value.trim();
          addCustomInterest(interest);
        }
      });
      
      // Handle remove buttons (using event delegation)
      customList.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-custom')) {
          const interest = e.target.dataset.interest;
          customInterests = customInterests.filter(i => i !== interest);
          e.target.parentElement.remove();
        }
      });
      
      saveButton.addEventListener('click', async () => {
        // Collect all selected interests
        const interestCheckboxes = document.querySelectorAll('input[name="interests"]:checked');
        const interests = Array.from(interestCheckboxes).map(cb => cb.value);
        
        // Get filtering enabled status
        const filteringEnabled = document.getElementById('enable-filtering').checked;
        
        // Send to server
        try {
          const response = await fetch('/api/preferences', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              interests: interests,
              custom_interests: customInterests,
              enabled: filteringEnabled
            }),
            credentials: 'include'
          });
          
          if (!response.ok) {
            throw new Error('Failed to save preferences');
          }
          
          // Show success toast
          showSuccess('Preferences saved successfully!');
          
        } catch (error) {
          console.error('Error saving preferences:', error);
          showError('Failed to save preferences. Please try again.');
        }
      });
    });

    // Toast Notification System
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toast-container');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        error: 'fas fa-exclamation-circle',
        success: 'fas fa-check-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
      };

      toast.innerHTML = `
        <i class="toast-icon ${icons[type]}"></i>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="removeToast(this)">×</button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        removeToast(toast.querySelector('.toast-close'));
      }, duration);
    }

    function removeToast(closeButton) {
      const toast = closeButton.closest('.toast');
      toast.classList.add('slide-out');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }

    function showError(message) {
      showToast(message, 'error', 5000);
    }

    function showSuccess(message) {
      showToast(message, 'success', 5000);
    }
  </script>
</body>
</html> 